name: Release On Tag

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux-windows:
    name: Build linux/windows binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install build tools
        run: |
          go install github.com/fyne-io/fyne-cross@v1.6.1
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Build binaries (linux, windows)
        run: |
          FYNE_CROSS="$(go env GOPATH)/bin/fyne-cross"
          APP_ID="com.grompt.app"
          "${FYNE_CROSS}" linux -pull -env=GOTOOLCHAIN=auto -arch=amd64,arm64 -output grompt -icon assets/icons/logo-1024.png ./cmd/grompt
          "${FYNE_CROSS}" windows -pull -env=GOTOOLCHAIN=auto -app-id "${APP_ID}" -arch=amd64 -output grompt -icon assets/icons/logo-1024.png ./cmd/grompt

      - name: Collect release assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets

          collect_binary() {
            local os="$1"
            local arch="$2"
            local output_name="$3"
            local base="fyne-cross/dist/${os}-${arch}"
            local destination="release-assets/${output_name}"
            local candidates=(
              "${base}/grompt"
              "${base}/grompt.exe"
            )

            for candidate in "${candidates[@]}"; do
              if [[ -f "${candidate}" ]]; then
                cp "${candidate}" "${destination}"
                return 0
              fi
            done

            echo "No binary found for ${os}/${arch} in ${base}" >&2
            ls -R "${base}" || true
            return 1
          }

          collect_binary linux amd64 grompt_linux_amd64
          collect_binary linux arm64 grompt_linux_arm64
          collect_binary windows amd64 grompt_windows_amd64.exe

      - name: Upload linux/windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-linux-windows
          path: release-assets/*
          if-no-files-found: error

  build-darwin:
    name: Build macOS app bundles
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install build tools
        run: |
          go install github.com/fyne-io/fyne-cross@v1.6.1
          go install fyne.io/fyne/v2/cmd/fyne@v2.7.3
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Build binaries (darwin)
        run: |
          FYNE_CROSS="$(go env GOPATH)/bin/fyne-cross"
          APP_ID="com.grompt.app"
          "${FYNE_CROSS}" darwin -local -env=GOTOOLCHAIN=local -app-id "${APP_ID}" -arch=amd64,arm64 -output grompt -icon assets/icons/logo-1024.png ./cmd/grompt

      - name: Collect release assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets

          collect_macos_app() {
            local arch="$1"
            local output_name="$2"
            local base="fyne-cross/dist/darwin-${arch}"
            local app_path="${base}/grompt.app"

            if [[ ! -d "${app_path}" ]]; then
              echo "No app bundle found for darwin/${arch} in ${base}" >&2
              ls -R "${base}" || true
              return 1
            fi

            (
              cd "${base}"
              zip -rq "${GITHUB_WORKSPACE}/release-assets/${output_name}" "grompt.app"
            )
          }

          collect_macos_app amd64 grompt_darwin_amd64.app.zip
          collect_macos_app arm64 grompt_darwin_arm64.app.zip

      - name: Upload darwin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-darwin
          path: release-assets/*
          if-no-files-found: error

  release:
    name: Publish release
    needs:
      - build-linux-windows
      - build-darwin
    runs-on: ubuntu-latest
    steps:
      - name: Download linux/windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets-linux-windows
          path: release-assets

      - name: Download darwin artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets-darwin
          path: release-assets

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
